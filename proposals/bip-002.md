# Explicit Annotated status and completeness information

| Field | Value |
| --- | --- |
| BIP | 2 |
| Title | Explicit Annotated status and completeness information |
| Author | Juanjo √Ålvarez |
| Status | Draft |
| Created | 2017-06-01 |
| Updated | 2017-08-01 |

## Abstract

This BIP proposed a new official (as in defined in the Node struct and
documented) "AnnotationStatus" property that would mark if the role has been
annotated in any way and the quality of the current annotation.

## Rationale

At the current stage of the Babelfish project, we strive for genericity in the list
of UAST roles and not adding very language-specific features into it until we can
have a wider view about how to integrate or compose these roles for covering as
much ground as possible. 

This is a worthy objective but has the problem of leaving the nodes related with
these features unannotated or with annotations that don't fully express all
the semantic information that the language source code or the native AST have.

This WIP-BIP proposes a mechanism to mark nodes with completion status (which
could use properties or roles and could vary on the mark details, see below in
*Proposed implementations* section).

This will make the UAST user have a wider view of the completeness of the
information provided by it on specific nodes and also could enable new uses cases
(whose specific definition is outside of the scope of this BIP) like helping debug
drivers and provide a completeness summary, with the added benefit of providing a
numerically observable measure of the completeness of every developed driver.

## Example

If a version of the UAST specification didn't have a role that could be matched
for a "coroutine" type function supported by some language, the UAST could still
mark those nodes as "FunctionDef", but without additional information, this would
be providing incomplete and even misleading information to UAST users that could
treat coroutines differently (for example when making stack call deep analysis).

The Unannotated and Annotated marks would be added or removed automatically by the
SDK (or alternatively by an external tool) so the driver developer would only have
to take care of adding the Incomplete mark. The implementation would be pretty
trivial on the SDK.

## Specification

This would modify the current specification by adding a new `AnnotationStatus`
property into the `Node` struct (and the UAST nodes) and a `const` enum with
the possible values.

## Proposed implementations

Feedback of the previous pull request produced several alternatives for the
different mechanism that could be used to implement this BIP. The options are
listed here for review but mostly so the project leader/benevolent dictator can
take execute decisions about the way this WIP-BIP will turn into a BIP with
concrete proposals.

### 1. Node properties or "meta" roles?

The completion mark/s could be implemented either using:

#### Option A: Node properties

Currently the SDK uses properties for some things. This would
add a new property "AnnotationStatus" (or similar name) that would hold a string
value with the annotation status mark.

##### Advantages

- It doesn't add new roles, thus not mixing with the role responsibility of
  holding language-related semantic meaning.

- Simple to implement on the SDK side since it won't change the role adding code.

##### Disadvantages

- It adds a new property that the clients and user would have to retrieve and read 
  to get the completion status (which won't happen with roles since clients 
  already read them).

- It would require the driver programmer to use a new function in the 
  annotation.go file (e.g.: "SetIncomplete()"), which would in turn have to be
  documented.

#### Option B: Additional roles

This would add one or more (depending on the proposed implementation 2) roles to
the UAST, like `Incomplete` and `Unannotated` and the driver programmer would add
them to the nodes with the SDK's `Roles()` function like any other nodes.

##### Advantages

- Very simple to implement, since it uses the already existing role mechanism;
  roles would have to be added to the `uast.go` enum and depending on proposed
  implementation 2 a default `Unannotated` role could be automatically added in
  the SDK.

- Doesn't change the driver programmer work flow since it would use the already
  existing `Roles()` function to add the new role/s.

##### Disadvantages

- Adds "meta" roles which are not anymore tied to the semantic meaning of the
  native AST nodes.

- The mixing of the roles could cause confusion in some use cases (e.g.: a user
  programming a tool to classify or relate nodes by their roles in the language
  could wrongly relate nodes by the completion status).

### 2. `Incomplete` or `Unnanotated+Incomplete` or `Annotated+Unnanotated+Incomplete`?

This decision related which how many completeness marks (be them either roles or
properties depending on decision 1) will be used to implement this BIP.

#### Option A: just `Incomplete`

If this option is chosen, we would only use the mark `Incomplete` to annotate
nodes which have existing annotations that doesn't communicate full semantic
information. 

With this options, the annotated and unannotated status would be implicit:

- Nodes with an empty role list would be considered unannotated.
- Nodes with a non-empty role list and no `Incomplete` mark would be considered
  annotated.

##### Advantages

- Simplest to implement since the SDK wouldn't have to automatically add any
  role or detect if the nodes have been annotated or not.

- Add less noise to the role/property list of a node.

##### Disadvantages

- Less *greppability* when searching for unannotated or fully annotated nodes or
  implementing annotation completion tests.

- Less obvious at first sigh.

#### Option B: `Unannotated+Incomplete`

This option skips the `Annotated` mark which would be implicit for any role that
doesn't have either an `Unannotated` or `Incomplete` mark. 

The driver developer would only have to add the `Incomplete` mark since the SDK's
annotation process would automatically add the `Unannotated` mark for nodes
without roles.

##### Advantages

- Less noise for fully annotated nodes.

- Better *greppability* for nodes that should take attention while ignoring the
  ones that doesn't need it.

##### Disadvantages

- Conceptual asymmetry 

- More complex to implement: the SDK have to detect and mark unannotated nodes.

- More noise in the roles or properties than option A (but less than option C).

#### Option C: `Annotated+Unannotated+Incomplete`

This option would provide a mark for every possible role completion level.

As in the previous case, the driver programmer would only have to add the
`Incomplete` mark with the SDK annotation process taking care of setting the
`Annotated` and `Unannotated` marks automatically.

##### Advantages

- Most explicit options.

- Easiest option for tools analyzing the completion status of drivers or specific
  UASTs.

- Most obvious completion information when visually checking an UAST.

##### Disadvantages

- Very noisy: it adds marks to every single node, even for 100% completed drivers.

- Slightly more complex to implement than B: the SDK have to detect and annotate
  both types of nodes that are not `Incomplete`.

## Impact

- Properties version: the `role.go` file would be modified for adding the new
  property in the `Role` struct and a `const` enum of the possible values. Roles
  version: the new roles would have to be added to the `uast.go` file and the
  drivers rebuild against it.

- The new roles or property values would have to be documented in the
  specification and the driver developer pages.

- The "Incomplete" mark would have to be added by the driver developers when
  defining the rules in the annotation.go file. If it's a role it would be added
  like any other role. If it's a property a new `SetIncomplete()` function would
  be added to the SDK, which would then have to be documented in the
  `annotations.md` file.

- If approved, the SDK would have to implement setting the `Annotated` and
  `Unannotated` marks.

- The documentation for the driver developer would have to be updated to include 
  the purpose and mechanics of these new property/s or role/s.

## References

- [Specification of the Node struct with the properties already in use](https://doc.bblf.sh/uast/specification.html)
